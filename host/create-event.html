<!doctype html><html lang="ja"><head>
    <meta charset="utf-8"/><meta name="viewport" content="width=device-width"/>
    <title>イベント作成</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body{font-family:system-ui,-apple-system,sans-serif;padding:16px}
      input,textarea,select,button{font-size:16px;padding:10px;width:100%;margin:8px 0}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      small{color:#666}
      img.preview{max-width:100%;display:none;border-radius:8px;margin:8px 0}
      #msg{white-space:pre-wrap;color:#b00020} #done{color:#0a7}
    </style>
  </head><body>
    <h1>イベント作成</h1>
  
    <form id="f">
      <label>イベント名*<input name="event_name" required></label>
      <label>イベント名（カナ）<input name="event_name_kana"></label>
      <div class="row">
        <label>ジャンル<input name="genre"></label>
        <label>ラベル<input name="label"></label>
      </div>
  
      <div class="row">
        <label>開始日<input name="start_date" type="date"></label>
        <label>終了日<input name="end_date" type="date"></label>
      </div>
      <div class="row">
        <label>開始時刻<input name="start_time" type="time"></label>
        <label>終了時刻<input name="end_time" type="time"></label>
      </div>
  
      <div class="row">
        <label>申込開始日<input name="apply_start" type="date"></label>
        <label>申込締切日<input name="apply_end" type="date"></label>
      </div>
  
      <label>リード<input name="lead" maxlength="120"></label>
      <label>紹介文<textarea name="description" rows="5"></textarea></label>
      <label>追記事項<textarea name="supplement" rows="3"></textarea></label>
  
      <label>メイン画像<input id="main_image_file" type="file" accept="image/*"></label>
      <img id="main_image_preview" class="preview" alt="preview">
      <input name="main_image" placeholder="https://..."/>
  
      <label>サブ画像URL（カンマ区切り）<input name="sub_images" placeholder="https://..., https://..."></label>
  
      <label>会場名<input name="venue_name"></label>
      <label>会場住所<input name="venue_address"></label>
      <div class="row">
        <label>緯度<input name="lat" type="number" step="any"></label>
        <label>経度<input name="lon" type="number" step="any"></label>
      </div>
  
      <label>主催名（表示用）<input name="organizer"></label>
      <div class="row">
        <label>連絡担当者<input name="contact_name"></label>
        <label>連絡電話<input name="contact_phone"></label>
      </div>
      <label>連絡メール<input name="contact_email" type="email"></label>
  
      <label>参加費・料金<input name="price"></label>
      <div class="row">
        <label>チケット発売日<input name="ticket_release" type="date"></label>
        <label>チケット販売場所<input name="ticket_place"></label>
      </div>
  
      <button type="submit">作成する</button>
    </form>
  
    <p id="done"></p>
    <p id="msg"></p>
  
    <script>
        const LIFF_ID = "2008126590-J2GZAlnx";
        
        async function ensureIdToken() {
          // 1) 初期化
          await liff.init({ liffId: LIFF_ID });
        
          // 2) 未ログインならログイン（リダイレクトで戻ってくる）
          if (!liff.isLoggedIn()) {
            liff.login();  // 戻ってきた後に再実行されます
            return null;
          }
        
          // 3) 取得
          let idt = liff.getIDToken();
        
          // 4) 取得できないケースのリカバリ（稀に起きる）
          //   - いったんログアウト→ログインで復帰することが多い
          if (!idt) {
            try { liff.logout(); } catch {}
            liff.login();
            return null;
          }
        
          return idt;
        }
        
        // 送信ハンドラ内をこのように書き換え
        document.getElementById('f').addEventListener('submit', async (e)=>{
          e.preventDefault();
          const btn = e.target.querySelector('button');
          btn.disabled = true; btn.textContent = '作成中…';
          try {
            const idToken = await ensureIdToken();
            if (!idToken) return; // ログインに飛んだ
        
            const event = Object.fromEntries(new FormData(e.target).entries());
            // 数値化などは既存の toObj を使ってOK（省略可）
        
            const r = await fetch('/api/create-event', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ idToken, event })
            });
            const t = await r.text(); let j={}; try{ j=t?JSON.parse(t):{} }catch{}
            if (!r.ok || !j.ok) {
              // 期限切れワードがあれば再ログイン
              if (/expired/i.test(j?.message||t||'')) { try{ liff.logout(); }catch{} liff.login(); return; }
              throw new Error(j?.message || `HTTP ${r.status} ${t}`);
            }
            // 成功表示
            document.getElementById('done').textContent = `作成しました（ID: ${j.event_id}）`;
          } catch (err) {
            document.getElementById('msg').textContent = String(err);
          } finally {
            btn.disabled = false; btn.textContent = '作成する';
          }
        });
        </script>
        
  </body></html>
  