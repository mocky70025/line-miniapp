<!doctype html><html lang="ja"><head>
    <meta charset="utf-8"/><meta name="viewport" content="width=device-width"/>
    <title>イベント作成</title>
    <style>
      body{font-family:system-ui,-apple-system,sans-serif;padding:16px}
      input,textarea,select,button{font-size:16px;padding:10px;width:100%;margin:8px 0}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      small{color:#666}
      img.preview{max-width:100%;display:none;border-radius:8px;margin:8px 0}
      #sub_images_preview{display:flex;gap:8px;flex-wrap:wrap}
      #sub_images_preview img{width:96px;height:96px;object-fit:cover;border-radius:8px}
      #msg{color:#b00020;white-space:pre-wrap}
      #done{color:#0a7}
    </style>
  </head><body>
    <h1>イベント作成</h1>
    <p id="msg"></p>
  
    <form id="f">
      <label>イベント名*<input name="event_name" required></label>
      <label>イベント名（カナ）<input name="event_name_kana"></label>
  
      <div class="row">
        <label>ジャンル<input name="genre"></label>
        <label>ラベル<input name="label"></label>
      </div>
  
      <div class="row">
        <label>開始日<input name="start_date" type="date"></label>
        <label>終了日<input name="end_date" type="date"></label>
      </div>
      <div class="row">
        <label>開始時刻<input name="start_time" type="time"></label>
        <label>終了時刻<input name="end_time" type="time"></label>
      </div>
  
      <div class="row">
        <label>申込開始日<input name="apply_start" type="date"></label>
        <label>申込締切日<input name="apply_end" type="date"></label>
      </div>
  
      <label>リード（概要100字）<input name="lead" maxlength="120"></label>
      <label>紹介文<textarea name="description" rows="5"></textarea></label>
      <label>追記事項<textarea name="supplement" rows="3"></textarea></label>
  
      <label>メイン画像
        <small>選ぶと自動アップロード→URLが下に入る</small>
        <input id="main_image_file" type="file" accept="image/*">
      </label>
      <img id="main_image_preview" class="preview" alt="preview">
      <input name="main_image" placeholder="https://..."/>
  
      <label>サブ画像（複数可）
        <input id="sub_images_files" type="file" accept="image/*" multiple>
      </label>
      <div id="sub_images_preview"></div>
      <input name="sub_images" placeholder="https://..., https://...">
  
      <label>会場名<input name="venue_name"></label>
      <label>会場住所<input name="venue_address"></label>
      <div class="row">
        <label>緯度<input name="lat" type="number" step="any"></label>
        <label>経度<input name="lon" type="number" step="any"></label>
      </div>
  
      <label>主催名（表示用）<input name="organizer"></label>
      <div class="row">
        <label>連絡担当者<input name="contact_name"></label>
        <label>連絡電話<input name="contact_phone"></label>
      </div>
      <label>連絡メール<input name="contact_email" type="email"></label>
  
      <label>参加費・料金<input name="price" placeholder="例：出店料3,000円/日"></label>
      <div class="row">
        <label>チケット発売日<input name="ticket_release" type="date"></label>
        <label>チケット販売場所<input name="ticket_place"></label>
      </div>
  
      <button type="submit">作成する</button>
    </form>
  
    <p id="done"></p>
  
    <script>
    function toObj(f){
      const o={}; new FormData(f).forEach((v,k)=>o[k]=String(v).trim());
      if(o.lat==='') delete o.lat; else o.lat=Number(o.lat);
      if(o.lon==='') delete o.lon; else o.lon=Number(o.lon);
      if(o.sub_images){
        const arr=o.sub_images.split(',').map(s=>s.trim()).filter(Boolean);
        o.sub_images = arr.length?arr:null;
      }
      return o;
    }
  
    async function uploadAndGetUrl(file, prefix='events'){
      const meta = await fetch('/api/upload-url',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({filename:file.name,prefix})}).then(r=>r.json());
      if(!meta?.ok) throw new Error(meta?.message||'get upload-url failed');
      const put = await fetch(meta.uploadUrl,{method:'PUT',headers:{'Content-Type':file.type||'application/octet-stream'},body:file});
      if(!put.ok) throw new Error('upload failed '+put.status);
      return meta.publicUrl;
    }
  
    const f=document.getElementById('f');
    const msg=document.getElementById('msg');
    const done=document.getElementById('done');
  
    const mainFile=document.getElementById('main_image_file');
    const mainPrev=document.getElementById('main_image_preview');
    mainFile.addEventListener('change', async ()=>{
      const file=mainFile.files?.[0]; if(!file) return;
      try{
        mainPrev.src=URL.createObjectURL(file); mainPrev.style.display='block';
        const url=await uploadAndGetUrl(file,'events');
        document.querySelector('input[name="main_image"]').value=url;
      }catch(e){ alert('画像アップロード失敗: '+e); mainPrev.style.display='none'; }
    });
  
    const subFiles=document.getElementById('sub_images_files');
    const subPrev=document.getElementById('sub_images_preview');
    subFiles.addEventListener('change', async ()=>{
      const files=Array.from(subFiles.files||[]); if(!files.length) return;
      try{
        const input=document.querySelector('input[name="sub_images"]');
        const urls=input.value?input.value.split(',').map(s=>s.trim()).filter(Boolean):[];
        for(const file of files){
          const url=await uploadAndGetUrl(file,'events');
          urls.push(url);
          const img=document.createElement('img'); img.src=url; subPrev.appendChild(img);
        }
        input.value=urls.join(', ');
      }catch(e){ alert('サブ画像アップロード失敗: '+e); }
    });
  
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msg.textContent=''; done.textContent='';
      const btn=f.querySelector('button'); btn.disabled=true; btn.textContent='作成中…';
      try{
        // DEV_MODE=true なら idToken なくても作成可（API側でバイパス）
        const event = toObj(f);
        const res = await fetch('/api/create-event',{method:'POST',headers:{'Content-Type':'application/json','x-dev-bypass':'1'},body:JSON.stringify({ idToken: null, event })});
        const text = await res.text(); let data={}; try{ data=JSON.parse(text) }catch{}
        if(!res.ok || !data.ok) throw new Error(data?.message || text || `HTTP ${res.status}`);
        done.textContent=`作成しました（ID: ${data.event_id}）`;
      }catch(err){ msg.textContent='失敗: '+String(err); }
      finally{ btn.disabled=false; btn.textContent='作成する'; }
    });
    </script>
  </body></html>
  