<!doctype html><html lang="ja"><head>
    <meta charset="utf-8"/><meta name="viewport" content="width=device-width"/>
    <title>イベント一覧</title>
    <style>
      body{font-family:system-ui,-apple-system,sans-serif;padding:16px}
      .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0;display:grid;grid-template-columns:96px 1fr;gap:12px;align-items:start}
      .thumb{width:96px;height:96px;object-fit:cover;border-radius:8px;background:#f3f3f3}
      .title{font-weight:600}
      .meta{color:#666;font-size:14px}
      .lead{margin:6px 0}
      .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:1px solid #0a7;color:#0a7;text-decoration:none}
      #msg{white-space:pre-wrap;color:#b00020;margin-bottom:8px}
    </style>
  </head><body>
  <h1>イベント一覧</h1>
  <p id="msg"></p>
  <div id="list">読み込み中...</div>
  
  <script>
  // 画面にエラーを出す（白画面対策）
  const msg = document.getElementById('msg');
  window.addEventListener('error', e=>{
    msg.textContent = 'Runtime Error: ' + (e?.error?.stack || e.message || e);
  });
  window.addEventListener('unhandledrejection', e=>{
    msg.textContent = 'Unhandled: ' + (e?.reason?.stack || e.reason || e);
  });
  
  async function load(){
    const list = document.getElementById('list');
    try{
      const r = await fetch('/api/list-events', { headers: { 'cache-control':'no-cache' }});
      const text = await r.text();
      let data = {};
      try{ data = text ? JSON.parse(text) : {}; }catch(e){ throw new Error('JSON parse error: '+e+'\nraw:'+text); }
      if(!r.ok || !data.ok) throw new Error(data?.message || 'HTTP '+r.status);
  
      const events = Array.isArray(data.events)? data.events : [];
      if(!events.length){ list.textContent = 'イベントはまだありません'; return; }
  
      list.innerHTML = '';
      events.forEach(ev=>{
        const d = document.createElement('div');
        d.className = 'card';
        d.innerHTML = `
          ${ev.main_image ? `<img class="thumb" src="${ev.main_image}" alt="">` : `<div class="thumb"></div>`}
          <div>
            <div class="title">${ev.event_name ?? '無題'} ${ev.label ? `<small class="meta">[${ev.label}]</small>`:''}</div>
            <div class="meta">${ev.start_date ?? ''} 〜 ${ev.end_date ?? ''}</div>
            <div class="meta">受付: ${ev.apply_start ?? '-'} 〜 ${ev.apply_end ?? '-'}</div>
            ${ev.lead ? `<p class="lead">${ev.lead}</p>` : ``}
            <a class="btn" href="/events/apply.html?event_id=${ev.id}">申し込む</a>
          </div>
        `;
        list.appendChild(d);
      });
    }catch(e){
      list.textContent = '取得に失敗しました';
      msg.textContent = String(e);
    }
  }
  load();
  </script>
  </body></html>
  